rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }
    
    function isAdmin() {
      // In a real app, use custom claims: request.auth.token.role == 'admin'
      // For now, we'll check a specific document or assume claims are set
      return isAuthenticated() && request.auth.token.role == 'admin';
    }
    
    function isMerchant() {
      return isAuthenticated() && request.auth.token.role == 'merchant';
    }

    // Users Collection
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin() || isMerchant(); // Merchants need to scan/read user by QR (via function usually, but maybe direct read if needed)
      allow create: if isAuthenticated() && request.auth.uid == userId; // User creation on first login
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin(); // Deletion via Cloud Function preferred
    }

    // Stores Collection
    match /stores/{storeId} {
      allow read: if resource.data.status == 'active' || isAdmin() || (isMerchant() && resource.data.owner_uid == request.auth.uid);
      allow create: if isAdmin(); // Only admins create stores or approve them
      allow update: if isAdmin() || (isMerchant() && resource.data.owner_uid == request.auth.uid); // Merchant can update branding
    }

    // Loyalty Data (The Wallet Cards)
    match /loyalty_data/{cardId} {
      // Users see their own cards. Merchants see cards for their store.
      allow read: if isOwner(resource.data.uid) || (isMerchant() && resource.data.store_id == request.auth.token.store_id) || isAdmin();
      // NO WRITE ACCESS from client/merchant SDKs. Must use Cloud Functions.
      allow write: if false; 
    }

    // System Content (News, Terms)
    match /system_content/{docId} {
      allow read: if true; // Public read
      allow write: if isAdmin();
    }

    // Audit Logs
    match /audit_logs/{logId} {
      allow read: if isAdmin();
      allow write: if false; // Only Cloud Functions write here
    }
  }
}
